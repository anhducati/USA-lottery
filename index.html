<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>XSMB Daily Dashboard</title>
  <meta name="description" content="Dashboard kết quả XSMB (Miền Bắc) cập nhật tự động từ GitHub Actions." />

  <style>
    :root{
      --bg1:#eef2ff;
      --bg2:#ffffff;
      --card:#ffffffcc;
      --stroke:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 10px 30px rgba(2,6,23,.10);
      --shadow2: 0 8px 18px rgba(2,6,23,.08);

      --r: 18px;
      --r2: 14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 20% 0%, #dbeafe 0%, transparent 60%),
        radial-gradient(900px 520px at 80% 0%, #fde68a 0%, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      padding: 18px 14px 40px;
    }

    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto}

    /* Topbar */
      .topbar{
        position: relative;   /* hoặc: position: static; */
        top: auto;
        z-index: auto;

        backdrop-filter: blur(14px);
        background: rgba(255,255,255,.55);
        border:1px solid rgba(255,255,255,.7);
        box-shadow: var(--shadow);
        border-radius: 26px;
        padding: 12px;
        overflow:hidden;
      }

    .topbar::before{
      content:"";
      position:absolute; inset:-2px;
      background: conic-gradient(from 210deg, #22c55e, #06b6d4, #a855f7, #f97316, #22c55e);
      filter: blur(18px);
      opacity:.35;
      z-index:-1;
    }
    .topbarInner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .brand{
      display:flex; gap:10px; align-items:center;
      min-width:280px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: conic-gradient(from 0deg, #60a5fa, #34d399, #fbbf24, #fb7185, #a78bfa, #60a5fa);
      box-shadow: var(--shadow2);
      flex:0 0 auto;
    }
    .title{
      line-height:1.15;
    }
    .title h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .title .sub{
      margin-top:3px;
      font-size:12.5px;
      color:var(--muted);
    }

    .metaRow{
      display:flex; flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
      width:100%;
    }

    .pill{
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.78);
      border:1px solid rgba(15,23,42,.08);
      border-radius: 999px;
      padding: 8px 10px;
      font-size:12.5px;
      color:#0f172a;
      box-shadow: 0 6px 14px rgba(2,6,23,.06);
      min-width: 0;
      max-width: 100%;
    }
    .pill b{font-weight:700}
    .dot{
      width:9px;height:9px;border-radius:999px;
      background: var(--warn);
      box-shadow: 0 0 0 3px rgba(245,158,11,.18);
      flex:0 0 auto;
    }
    .dot.ok{background:var(--ok); box-shadow:0 0 0 3px rgba(22,163,74,.18)}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.18)}

    .btnRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      width:100%;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.82);
      border-radius: 999px;
      padding: 8px 10px;
      font-size:12.5px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow: 0 6px 14px rgba(2,6,23,.06);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .btn:hover{background:#fff}
    .btn:active{transform: translateY(1px)}
    .btn code{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:12px}

    /* Content */
    .section{margin-top:16px}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(15,23,42,.08);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      padding: 16px;
      overflow:hidden;
    }

    .cardHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 12px;
    }
    .cardHeader h2{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .muted{color:var(--muted);font-size:13px}

    .statusLine{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.75);
      margin-bottom: 12px;
    }
    .statusLine.ok{border-color: rgba(22,163,74,.22); background: rgba(22,163,74,.08)}
    .statusLine.warn{border-color: rgba(245,158,11,.22); background: rgba(245,158,11,.10)}
    .statusLine.bad{border-color: rgba(239,68,68,.22); background: rgba(239,68,68,.08)}
    .statusText{font-size:13px}

    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }
    .stat{
      background: rgba(255,255,255,.82);
      border:1px solid rgba(15,23,42,.08);
      border-radius: 14px;
      padding: 12px 12px;
      min-width:0;
    }
    .stat .k{font-size:12px;color:var(--muted)}
    .stat .v{
      margin-top:6px;
      font-size:20px;
      font-weight:800;
      letter-spacing:.3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.82);
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid rgba(15,23,42,.06);
      font-size:13px;
      vertical-align:top;
    }
    th{
      text-align:left;
      color:#0f172a;
      background: rgba(2,6,23,.03);
      font-weight:700;
    }
    tr:last-child td{border-bottom:none}

    .scrollX{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 14px;
    }

    .chips{
      display:flex; flex-wrap:wrap; gap:6px;
    }
    .chip{
      padding:6px 8px;
      border-radius: 999px;
      background: rgba(2,6,23,.04);
      border:1px solid rgba(15,23,42,.06);
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;
      line-height:1;
    }

    /* Charts */
    .chartGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .chartCard{
      border-radius: 16px;
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.82);
      overflow:hidden;
      box-shadow: 0 10px 20px rgba(2,6,23,.06);
    }
    .chartHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      gap:10px;
      border-bottom:1px solid rgba(15,23,42,.06);
    }
    .chartTitle{
      font-weight:800;
      font-size:13.5px;
      margin:0;
    }
    .chartBody{
      padding:10px 12px 12px;
    }
    .chartBody img{
      width:100%;
      height:auto;
      border-radius: 12px;
      display:block;
      background: rgba(2,6,23,.03);
    }

    /* Info tooltip */
    .infoWrap{position:relative; display:inline-flex; align-items:center; gap:8px}
    .infoBtn{
      width:28px;height:28px;border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.9);
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      font-weight:900;
      color:#0f172a;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .infoBtn:active{transform: translateY(1px)}
    .popover{
      position:absolute;
      right:0;
      top:36px;
      width: 320px;
      max-width: 86vw;
      border-radius: 14px;
      background: #0b1220;
      color: #e5e7eb;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 50px rgba(2,6,23,.35);
      padding: 10px 10px;
      font-size: 12.5px;
      line-height: 1.45;
      display:none;
      pointer-events:auto;
    }
    .popover::before{
      content:"";
      position:absolute;
      top:-6px;
      right: 12px;
      width: 12px; height:12px;
      transform: rotate(45deg);
      background: #0b1220;
      border-left:1px solid rgba(255,255,255,.12);
      border-top:1px solid rgba(255,255,255,.12);
    }
    .infoBtn.open + .popover{display:block}

    /* Desktop hover (tuỳ) */
    @media (hover:hover){
      .infoBtn:hover + .popover{display:block}
    }

    /* Footer */
    .footer{
      margin-top: 18px;
      text-align:center;
      color: var(--muted);
      font-size: 12.5px;
    }

    /* Responsive fixes */
    @media (max-width: 900px){
      .topbarInner{
        flex-direction:column;
        align-items:stretch;
        gap:10px;
      }
      .brand{min-width:unset; width:100%}
      .metaRow{justify-content:flex-start; width:100%; gap:8px}

      .pill{flex:1 1 auto; min-width:0; max-width:100%}
      .pill:nth-child(1){flex: 1 1 100%}
      .pill:nth-child(2),
      .pill:nth-child(3),
      .pill:nth-child(4){flex: 1 1 calc(50% - 6px)}

      .btnRow{width:100%}
      .btn{flex: 1 1 calc(33.33% - 6px); text-align:center; padding:10px 10px}

      .stats{grid-template-columns: 1fr}
      .chartGrid{grid-template-columns: 1fr}
      table{min-width:860px}
    }

    @media (max-width: 520px){
      .popover{
        left:50%;
        right:auto;
        transform: translateX(-50%);
        width: min(340px, 88vw);
      }
      .popover::before{
        left:50%;
        right:auto;
        transform: translateX(-50%) rotate(45deg);
      }
    }

    @media (max-width: 420px){
      body{padding: 14px 12px 34px}
      .card{padding:14px}
      .title h1{font-size:16px}
      .pill{font-size:12px}
      .btn{font-size:12px; flex: 1 1 100%}

      .pill:nth-child(2),
      .pill:nth-child(3),
      .pill:nth-child(4){flex: 1 1 100%}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbarInner">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="title">
            <h1>XSMB Daily Dashboard</h1>
            <div class="sub">Cập nhật 18:30 VN (tự retry nếu trễ) • Giao diện tối ưu cho di động • 100% tiếng Việt</div>
          </div>
        </div>

        <div class="metaRow">
          <div class="pill" id="pillStatus">
            <span class="dot" id="statusDot"></span>
            <span id="statusText"><b>Đang tải…</b> • kiểm tra dữ liệu</span>
          </div>
          <div class="pill"><span class="muted">Updated (VN):</span> <b id="metaUpdated">—</b></div>
          <div class="pill"><span class="muted">SHA:</span> <b id="metaSha">—</b></div>
          <div class="pill"><span class="muted">Run:</span> <b id="metaRun">—</b></div>

          <div class="btnRow">
            <a class="btn" id="btnXsmb" href="./data/xsmb.json" target="_blank" rel="noopener"><code>xsmb.json</code></a>
            <a class="btn" id="btnLast7" href="./data/last7.json" target="_blank" rel="noopener"><code>last7.json</code></a>
            <a class="btn" id="btnMeta" href="./data/site_meta.json" target="_blank" rel="noopener"><code>meta</code></a>
          </div>
        </div>
      </div>
    </div>

    <!-- KẾT QUẢ MỚI NHẤT -->
    <div class="section card">
      <div class="cardHeader">
        <h2>Kết quả mới nhất</h2>
        <div class="muted">Nguồn: <span id="metaSource">—</span></div>
      </div>

      <div class="statusLine" id="lineStatus">
        <span class="dot" id="lineDot"></span>
        <div class="statusText" id="lineText">Đang tải dữ liệu…</div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="k">Ngày</div>
          <div class="v" id="statDate">—</div>
        </div>
        <div class="stat">
          <div class="k">Giải đặc biệt (ĐB)</div>
          <div class="v" id="statSpecial">—</div>
        </div>
        <div class="stat">
          <div class="k">Đề (2 số cuối ĐB)</div>
          <div class="v" id="statDe">—</div>
        </div>
      </div>

      <div class="scrollX">
        <table>
          <thead>
            <tr>
              <th style="width:170px">Giải</th>
              <th>Kết quả</th>
            </tr>
          </thead>
          <tbody id="tblLatest">
            <tr><td colspan="2" class="muted">Đang tải…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="footer">© Tự động tạo bởi GitHub Actions</div>
    </div>

    <!-- LỊCH 7 NGÀY -->
    <div class="section card">
      <div class="cardHeader">
        <h2>Lịch gần nhất 7 ngày (full)</h2>
        <div class="muted">Tự format số theo quy tắc giải</div>
      </div>

      <div class="scrollX">
        <table>
          <thead>
            <tr>
              <th style="width:120px">Ngày</th>
              <th>ĐB</th>
              <th>Nhất</th>
              <th>Nhì</th>
              <th>Ba</th>
              <th>Tư</th>
              <th>Năm</th>
              <th>Sáu</th>
              <th>Bảy</th>
            </tr>
          </thead>
          <tbody id="tblLast7">
            <tr><td colspan="9" class="muted">Đang tải…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- BIỂU ĐỒ -->
    <div class="section card">
      <div class="cardHeader">
        <h2>Biểu đồ (tự ẩn nếu chưa có ảnh)</h2>
        <div class="muted">Nếu ảnh tồn tại trong <code>/images</code> thì sẽ hiển thị</div>
      </div>

      <div class="chartGrid" id="chartGrid">
        <!-- Card chart mẫu (JS sẽ fill) -->
      </div>

      <div class="muted" style="margin-top:10px">
        Mẹo: Trên điện thoại, bấm vào nút <b>i</b> để xem chú thích. Bấm ra ngoài để đóng.
      </div>
    </div>

    <div class="footer" style="margin-top:14px">
      Phiên bản tiếng Việt • Hiển thị tối ưu cho di động • Tự format số theo quy tắc giải
    </div>
  </div>

  <script>
    // ========= Helpers =========
    const $ = (sel) => document.querySelector(sel);

    function padLeft(n, width){
      const s = String(n ?? "");
      return s.padStart(width, "0");
    }

    // Quy tắc hiển thị (KHÔNG sửa JSON, chỉ sửa hiển thị):
    // • ĐB: 5 số • Giải 1: 5 • Giải 2/3: 5 • Giải 4/5: 4 • Giải 6: 3 • Giải 7: 2
    function formatPrize(key, value){
      if (value === null || value === undefined || value === "") return "—";
      const v = Number(value);

      // date không format ở đây
      if (Number.isNaN(v)) return String(value);

      // map độ dài theo key
      // special, prize1, prize2_*, prize3_* => 5
      // prize4_*, prize5_* => 4
      // prize6_* => 3
      // prize7_* => 2
      let w = 0;
      if (key === "special" || key === "prize1" || key.startsWith("prize2_") || key.startsWith("prize3_")) w = 5;
      else if (key.startsWith("prize4_") || key.startsWith("prize5_")) w = 4;
      else if (key.startsWith("prize6_")) w = 3;
      else if (key.startsWith("prize7_")) w = 2;
      else w = 0;

      return w ? padLeft(v, w) : String(v);
    }

    function formatDateVN(isoLike){
      if (!isoLike) return "—";
      const d = new Date(isoLike);
      if (isNaN(d.getTime())) return String(isoLike);

      // dd/mm/yyyy theo VN (Asia/Ho_Chi_Minh)
      return d.toLocaleDateString("vi-VN", { timeZone:"Asia/Ho_Chi_Minh" });
    }

    // Xuất đúng dạng: 2026-01-14T19:25:05.202618+07:00 (microseconds nếu có -> giữ tối đa 6)
    // Nếu đầu vào có sẵn offset +07:00 thì dùng nguyên. Nếu không -> convert sang +07:00.
    function toIsoWithVNOffset(input){
      if (!input) return "—";
      const s = String(input);

      // Nếu đã có dạng ...+07:00 hoặc +0700 hoặc Z hoặc +/-hh:mm, giữ/chuẩn hoá nhẹ
      const hasTZ = /([zZ]|[+\-]\d{2}:?\d{2})$/.test(s);
      if (hasTZ){
        // Chuẩn hoá +0700 => +07:00
        return s.replace(/([+\-]\d{2})(\d{2})$/, "$1:$2");
      }

      // Không có timezone => hiểu là UTC (hoặc local). Ta coi là UTC để ổn định.
      const d = new Date(s + "Z");
      if (isNaN(d.getTime())) {
        // fallback: parse bình thường rồi convert
        const d2 = new Date(s);
        if (isNaN(d2.getTime())) return s;
        return isoOffsetFromUTCms(d2.getTime(), 420, 3) + "+07:00";
      }

      // Convert UTC->+07:00
      return isoOffsetFromUTCms(d.getTime(), 420, 3) + "+07:00";
    }

    // Build ISO string at fixed offset using UTC getters (no timezone drift)
    // precisionMs: 3 => .SSS ; can output 6 by reading from input is impossible, so keep 3.
    function isoOffsetFromUTCms(utcMs, offsetMin, precisionMs=3){
      const ms = utcMs + offsetMin*60*1000; // shift into "fake UTC" = VN time
      const d = new Date(ms);

      const Y = d.getUTCFullYear();
      const M = String(d.getUTCMonth()+1).padStart(2,"0");
      const D = String(d.getUTCDate()).padStart(2,"0");
      const h = String(d.getUTCHours()).padStart(2,"0");
      const m = String(d.getUTCMinutes()).padStart(2,"0");
      const s = String(d.getUTCSeconds()).padStart(2,"0");
      const ms3 = String(d.getUTCMilliseconds()).padStart(3,"0");

      // luôn xuất .SSS (bạn cần microseconds thực sự thì phải ghi từ Python vào meta)
      return `${Y}-${M}-${D}T${h}:${m}:${s}.${ms3}`;
    }

    async function fetchJson(url, opts={}){
      const { allow404=false } = opts;
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok){
        if (allow404 && res.status === 404) return null;
        throw new Error(`${url} HTTP ${res.status}`);
      }
      return await res.json();
    }

    function setStatus(kind, text){
      const dot = $("#statusDot");
      const pill = $("#pillStatus");
      dot.classList.remove("ok","bad");
      pill.style.borderColor = "";

      if (kind === "ok"){
        dot.classList.add("ok");
      } else if (kind === "bad"){
        dot.classList.add("bad");
      }
      $("#statusText").innerHTML = text;

      const line = $("#lineStatus");
      const lineDot = $("#lineDot");
      line.classList.remove("ok","warn","bad");
      lineDot.classList.remove("ok","bad");

      if (kind === "ok"){ line.classList.add("ok"); lineDot.classList.add("ok"); }
      else if (kind === "warn"){ line.classList.add("warn"); }
      else { line.classList.add("bad"); lineDot.classList.add("bad"); }

      $("#lineText").textContent = stripHtml(text);
    }

    function stripHtml(html){
      const div = document.createElement("div");
      div.innerHTML = html;
      return div.textContent || div.innerText || "";
    }

    function mkRow(label, values){
      const tr = document.createElement("tr");
      const td1 = document.createElement("td");
      const td2 = document.createElement("td");
      td1.textContent = label;

      const chips = document.createElement("div");
      chips.className = "chips";
      values.forEach(v=>{
        const c = document.createElement("span");
        c.className = "chip";
        c.textContent = v;
        chips.appendChild(c);
      });
      td2.appendChild(chips);

      tr.appendChild(td1);
      tr.appendChild(td2);
      return tr;
    }

    function safeArray(v){
      return Array.isArray(v) ? v : (v ? [v] : []);
    }

    function getTwoLastDigits(s){
      if (!s || s === "—") return "—";
      const x = String(s).replace(/\D/g,"");
      if (!x) return "—";
      return x.slice(-2).padStart(2,"0");
    }

    // ========= Charts =========
    const CHARTS = [
      { file: "top10.jpg", title: "Top 10 số lâu chưa về (text)", tip: "Danh sách 10 số có số ngày (delta) lớn nhất tính đến hiện tại." },
      { file: "top10_30d.jpg", title: "Top 10 số lâu chưa về (30 ngày)", tip: "Top 10 tính riêng theo cửa sổ 30 ngày gần nhất." },
      { file: "delta.jpg", title: "Phân bố delta (ngày)", tip: "Biểu đồ phân bố số ngày chưa về (delta) theo từng số." },
      { file: "delta_top_10.jpg", title: "Top delta nổi bật", tip: "Nhóm số có delta cao nhất, giúp nhìn nhanh các số nổi bật." },
      { file: "distribution.jpg", title: "Phân phối 2 số cuối (tần suất)", tip: "Tần suất xuất hiện 2 số cuối theo lịch sử dữ liệu." },
      { file: "heatmap.jpg", title: "Heatmap 2 số cuối", tip: "Bản đồ nhiệt tần suất theo hai chữ số (00–99)." },
      { file: "line_30d_total.jpg", title: "Xu hướng 30 ngày: tổng lượt", tip: "Đường xu hướng tổng lượt xuất hiện theo từng ngày trong 30 ngày." },
      { file: "line_30d_unique.jpg", title: "Xu hướng 30 ngày: số lượng số khác nhau", tip: "Đường xu hướng số lượng 2 số cuối khác nhau theo từng ngày trong 30 ngày." },
    ];

    function renderCharts(){
      const grid = $("#chartGrid");
      grid.innerHTML = "";

      CHARTS.forEach((c, idx)=>{
        const card = document.createElement("div");
        card.className = "chartCard";
        card.dataset.file = c.file;

        const head = document.createElement("div");
        head.className = "chartHead";

        const t = document.createElement("div");
        t.style.display = "flex";
        t.style.alignItems = "center";
        t.style.gap = "10px";

        const h = document.createElement("div");
        h.className = "chartTitle";
        h.textContent = c.title;

        const infoWrap = document.createElement("span");
        infoWrap.className = "infoWrap";

        const btn = document.createElement("button");
        btn.className = "infoBtn";
        btn.type = "button";
        btn.setAttribute("aria-label", "Chú thích biểu đồ");
        btn.textContent = "i";

        const pop = document.createElement("div");
        pop.className = "popover";
        pop.innerHTML = `<b>Chú thích</b><div style="height:6px"></div>${escapeHtml(c.tip)}`;

        infoWrap.appendChild(btn);
        infoWrap.appendChild(pop);

        t.appendChild(h);
        t.appendChild(infoWrap);

        head.appendChild(t);

        const body = document.createElement("div");
        body.className = "chartBody";

        const img = document.createElement("img");
        img.alt = c.title;
        img.loading = "lazy";
        img.decoding = "async";
        img.dataset.src = `./images/${c.file}`;
        img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
          `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="420">
             <rect width="100%" height="100%" fill="rgba(2,6,23,0.03)"/>
             <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="rgba(2,6,23,0.35)" font-size="18">
               Đang kiểm tra ảnh…
             </text>
           </svg>`
        );

        body.appendChild(img);
        card.appendChild(head);
        card.appendChild(body);
        grid.appendChild(card);
      });

      // Sau khi render, kiểm tra ảnh tồn tại thì gán thật, không tồn tại thì ẩn card
      checkAndLoadChartImages();
      enableMobilePopovers();
    }

    function checkAndLoadChartImages(){
      const cards = Array.from(document.querySelectorAll(".chartCard"));
      cards.forEach(card=>{
        const img = card.querySelector("img");
        const url = img.dataset.src;

        const test = new Image();
        test.onload = () => {
          img.src = url + `?v=${Date.now()}`; // bust cache nhẹ khi dev
          card.style.display = "";
        };
        test.onerror = () => {
          card.style.display = "none";
        };
        test.src = url + `?probe=${Date.now()}`;
      });

      // Nếu tất cả đều ẩn -> hiện 1 box thông báo
      setTimeout(()=>{
        const anyVisible = cards.some(c=>c.style.display !== "none");
        if (!anyVisible){
          $("#chartGrid").innerHTML =
            `<div class="statusLine warn" style="grid-column:1/-1">
               <span class="dot"></span>
               <div class="statusText">
                 Hiện chưa có ảnh biểu đồ trong thư mục <code>/images</code> (hoặc tên file không khớp). Khi workflow tạo ảnh, các ô sẽ tự hiện.
               </div>
             </div>`;
        }
      }, 350);
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    // ========= Tooltip click (mobile) =========
    function enableMobilePopovers(){
      document.addEventListener("click", (e) => {
        const btn = e.target.closest(".infoBtn");

        // bấm trong popover -> không đóng
        if (e.target.closest(".popover")) return;

        // bấm ngoài -> đóng hết
        if (!btn){
          document.querySelectorAll(".infoBtn.open").forEach(x => x.classList.remove("open"));
          return;
        }

        // toggle đúng nút
        document.querySelectorAll(".infoBtn.open").forEach(x => {
          if (x !== btn) x.classList.remove("open");
        });
        btn.classList.toggle("open");
        e.preventDefault();
        e.stopPropagation();
      }, false);

      document.addEventListener("touchstart", (e) => {
        const btn = e.target.closest(".infoBtn");
        if (!btn && !e.target.closest(".popover")){
          document.querySelectorAll(".infoBtn.open").forEach(x => x.classList.remove("open"));
        }
      }, {passive:true});
    }

    // ========= Render latest =========
    function renderLatestFromItem(item){
      const dateVN = formatDateVN(item.date);
      const special = formatPrize("special", item.special);

      $("#statDate").textContent = dateVN;
      $("#statSpecial").textContent = special;
      $("#statDe").textContent = getTwoLastDigits(special);

      const tbody = $("#tblLatest");
      tbody.innerHTML = "";

      // Build groups
      const g = {
        "Giải ĐB": [formatPrize("special", item.special)],
        "Giải nhất": [formatPrize("prize1", item.prize1)],
        "Giải nhì": [formatPrize("prize2_1", item.prize2_1), formatPrize("prize2_2", item.prize2_2)],
        "Giải ba": [
          formatPrize("prize3_1", item.prize3_1),
          formatPrize("prize3_2", item.prize3_2),
          formatPrize("prize3_3", item.prize3_3),
          formatPrize("prize3_4", item.prize3_4),
          formatPrize("prize3_5", item.prize3_5),
          formatPrize("prize3_6", item.prize3_6),
        ],
        "Giải tư": [
          formatPrize("prize4_1", item.prize4_1),
          formatPrize("prize4_2", item.prize4_2),
          formatPrize("prize4_3", item.prize4_3),
          formatPrize("prize4_4", item.prize4_4),
        ],
        "Giải năm": [
          formatPrize("prize5_1", item.prize5_1),
          formatPrize("prize5_2", item.prize5_2),
          formatPrize("prize5_3", item.prize5_3),
          formatPrize("prize5_4", item.prize5_4),
          formatPrize("prize5_5", item.prize5_5),
          formatPrize("prize5_6", item.prize5_6),
        ],
        "Giải sáu": [
          formatPrize("prize6_1", item.prize6_1),
          formatPrize("prize6_2", item.prize6_2),
          formatPrize("prize6_3", item.prize6_3),
        ],
        "Giải bảy": [
          formatPrize("prize7_1", item.prize7_1),
          formatPrize("prize7_2", item.prize7_2),
          formatPrize("prize7_3", item.prize7_3),
          formatPrize("prize7_4", item.prize7_4),
        ],
      };

      Object.entries(g).forEach(([label, arr])=>{
        const values = arr.filter(x=>x && x !== "—");
        tbody.appendChild(mkRow(label, values.length ? values : ["—"]));
      });
    }

    // ========= Render last7 =========
    function renderLast7(list){
      const tbody = $("#tblLast7");
      tbody.innerHTML = "";

      if (!Array.isArray(list) || list.length === 0){
        tbody.innerHTML = `<tr><td colspan="9" class="muted">Chưa có dữ liệu last7.</td></tr>`;
        return;
      }

      list.forEach(item=>{
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = formatDateVN(item.date);

        const tdDB = document.createElement("td");
        tdDB.textContent = formatPrize("special", item.special);

        const td1 = document.createElement("td");
        td1.textContent = formatPrize("prize1", item.prize1);

        const td2 = document.createElement("td");
        td2.textContent = [
          formatPrize("prize2_1", item.prize2_1),
          formatPrize("prize2_2", item.prize2_2),
        ].filter(x=>x!=="—").join(", ");

        const td3 = document.createElement("td");
        td3.textContent = [
          formatPrize("prize3_1", item.prize3_1),
          formatPrize("prize3_2", item.prize3_2),
          formatPrize("prize3_3", item.prize3_3),
          formatPrize("prize3_4", item.prize3_4),
          formatPrize("prize3_5", item.prize3_5),
          formatPrize("prize3_6", item.prize3_6),
        ].filter(x=>x!=="—").join(", ");

        const td4 = document.createElement("td");
        td4.textContent = [
          formatPrize("prize4_1", item.prize4_1),
          formatPrize("prize4_2", item.prize4_2),
          formatPrize("prize4_3", item.prize4_3),
          formatPrize("prize4_4", item.prize4_4),
        ].filter(x=>x!=="—").join(", ");

        const td5 = document.createElement("td");
        td5.textContent = [
          formatPrize("prize5_1", item.prize5_1),
          formatPrize("prize5_2", item.prize5_2),
          formatPrize("prize5_3", item.prize5_3),
          formatPrize("prize5_4", item.prize5_4),
          formatPrize("prize5_5", item.prize5_5),
          formatPrize("prize5_6", item.prize5_6),
        ].filter(x=>x!=="—").join(", ");

        const td6 = document.createElement("td");
        td6.textContent = [
          formatPrize("prize6_1", item.prize6_1),
          formatPrize("prize6_2", item.prize6_2),
          formatPrize("prize6_3", item.prize6_3),
        ].filter(x=>x!=="—").join(", ");

        const td7 = document.createElement("td");
        td7.textContent = [
          formatPrize("prize7_1", item.prize7_1),
          formatPrize("prize7_2", item.prize7_2),
          formatPrize("prize7_3", item.prize7_3),
          formatPrize("prize7_4", item.prize7_4),
        ].filter(x=>x!=="—").join(", ");

        tr.append(tdDate, tdDB, td1, td2, td3, td4, td5, td6, td7);
        tbody.appendChild(tr);
      });
    }

    // ========= Main =========
    async function main(){
      renderCharts();

      // 1) Load meta trước để hiển thị Updated(VN)
      let meta = null;
      try{
        meta = await fetchJson("./data/site_meta.json", { allow404:true });
      }catch(e){
        // meta lỗi không chặn trang
        meta = null;
      }

      if (meta){
        // Updated (VN): ưu tiên meta.updated_at_vn / meta.updated_vn
        const updatedVnRaw = meta.updated_at_vn || meta.updated_vn || meta.updated_at || meta.updated || meta.updated_at_utc || meta.updated_utc || "";
        const updatedVn = toIsoWithVNOffset(updatedVnRaw);
        $("#metaUpdated").textContent = updatedVn || "—";

        $("#metaSha").textContent = meta.sha || "—";
        $("#metaRun").textContent = meta.run_id || meta.run || "—";
        $("#metaSource").textContent = meta.source || "—";

        // Status theo note nếu có
        const note = String(meta.note || "").toLowerCase();
        if (note.includes("chưa") || note.includes("chua") || note.includes("no data")){
          setStatus("warn", "<b>Online</b> • Chưa có dữ liệu");
        } else {
          setStatus("ok", "<b>Online</b> • Đã tải dữ liệu");
        }
      } else {
        $("#metaUpdated").textContent = "—";
        $("#metaSha").textContent = "—";
        $("#metaRun").textContent = "—";
        $("#metaSource").textContent = "—";
        setStatus("warn", "<b>Online</b> • Chưa có meta (site_meta.json)");
      }

      // 2) Load xsmb.json (latest list)
      let xsmb = null;
      try{
        xsmb = await fetchJson("./data/xsmb.json");
      }catch(e){
        setStatus("bad", `<b>Lỗi</b> • ./data/xsmb.json ${escapeHtml(e.message).replace("./data/xsmb.json ","")}`);
        $("#tblLatest").innerHTML = `<tr><td>Lỗi</td><td>${escapeHtml(e.message)}</td></tr>`;
        return;
      }

      if (!Array.isArray(xsmb) || xsmb.length === 0){
        setStatus("warn", "<b>Online</b> • xsmb.json trống (chưa có dữ liệu)");
        $("#tblLatest").innerHTML = `<tr><td colspan="2" class="muted">Chưa có dữ liệu hôm nay.</td></tr>`;
      } else {
        // Lấy phần tử cuối cùng (mới nhất)
        const latest = xsmb[xsmb.length - 1];
        renderLatestFromItem(latest);
      }

      // 3) Load last7.json
      try{
        const last7 = await fetchJson("./data/last7.json", { allow404:true });
        if (last7) renderLast7(last7);
        else $("#tblLast7").innerHTML = `<tr><td colspan="9" class="muted">Chưa có file last7.json</td></tr>`;
      }catch(e){
        $("#tblLast7").innerHTML = `<tr><td colspan="9" class="muted">Lỗi last7.json: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    main();
  </script>
</body>
</html>
