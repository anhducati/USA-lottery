<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>XSMB Daily Dashboard</title>

  <!-- Bootstrap 5 (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --card-radius: 18px;
      --glass: rgba(255,255,255,.72);
      --glass-2: rgba(255,255,255,.58);
      --border: rgba(15, 23, 42, .10);
      --shadow: 0 12px 30px rgba(0,0,0,.08);
      --shadow2: 0 8px 18px rgba(0,0,0,.08);
    }
    body{
      background:
        radial-gradient(1200px 500px at 18% 6%, rgba(34,197,94,.22), transparent 55%),
        radial-gradient(900px 520px at 92% 8%, rgba(59,130,246,.22), transparent 60%),
        radial-gradient(900px 600px at 55% 100%, rgba(236,72,153,.12), transparent 60%),
        linear-gradient(180deg, #f8fafc 0%, #ffffff 55%, #f8fafc 100%);
      color:#0f172a;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container-max{
      max-width: 1200px;
    }

    .hero{
      background: linear-gradient(90deg, rgba(34,197,94,.18), rgba(59,130,246,.18), rgba(236,72,153,.18));
      border: 1px solid var(--border);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }
    .hero::after{
      content:"";
      position:absolute; inset:-60px -60px auto auto;
      width: 220px; height: 220px;
      background: radial-gradient(circle, rgba(255,255,255,.5), transparent 60%);
      filter: blur(1px);
      transform: rotate(8deg);
      pointer-events:none;
    }

    .brand-badge{
      width: 56px; height: 56px;
      border-radius: 18px;
      background: conic-gradient(from 120deg, #22c55e, #3b82f6, #ec4899, #f59e0b, #22c55e);
      box-shadow: 0 10px 24px rgba(0,0,0,.15);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      padding: .4rem .7rem;
      border-radius: 999px;
      background: var(--glass);
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      font-size: .9rem;
      line-height: 1;
      white-space: nowrap;
    }
    .chip .dot{
      width: .6rem; height: .6rem; border-radius: 99px;
      background: #e2e8f0;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.06);
    }
    .dot.ok{ background:#22c55e; }
    .dot.warn{ background:#f59e0b; }
    .dot.bad{ background:#ef4444; }

    .btn-chip{
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.7);
      padding: .42rem .75rem;
      font-weight: 600;
    }

    .card-glass{
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow2);
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    .big-number{
      font-size: clamp(1.15rem, 3.4vw, 1.5rem);
      font-weight: 800;
      letter-spacing: .3px;
    }

    .table thead th{
      font-weight: 800;
      border-bottom: 1px solid rgba(0,0,0,.08) !important;
    }

    .img-chart{
      width: 100%;
      height: auto;
      display:block;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.5);
    }

    .help-i{
      width: 22px; height: 22px;
      border-radius: 99px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(15,23,42,.18);
      background: rgba(255,255,255,.7);
      color:#0f172a;
      font-size: .85rem;
      cursor: pointer;
      user-select:none;
    }

    .section-title{
      font-weight: 900;
      letter-spacing: .2px;
    }

    /* Mobile tweaks */
    @media (max-width: 576px){
      .hero{
        border-radius: 22px;
      }
      .brand-badge{
        width: 50px; height: 50px; border-radius: 16px;
      }
      .chip{
        font-size: .85rem;
        padding: .38rem .62rem;
      }
      .btn-chip{
        padding: .38rem .62rem;
        font-size: .9rem;
      }
      .card-glass{
        border-radius: 16px;
      }
    }
  </style>
</head>

<body>
  <div class="container container-max py-3 py-md-4">

    <!-- HEADER / HERO -->
    <div class="hero p-3 p-md-4 mb-3 mb-md-4">
      <div class="d-flex align-items-start gap-3 flex-wrap">
        <div class="brand-badge flex-shrink-0"></div>

        <div class="flex-grow-1">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
            <div>
              <div class="h3 mb-0 fw-black" style="font-weight: 900;">XSMB Daily Dashboard</div>
              <div class="text-secondary mt-1">
                Cập nhật 18:30 VN (tự thử lại mỗi ~5 phút nếu trễ)
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 justify-content-end">
              <span class="chip" id="chipStatus">
                <span class="dot" id="statusDot"></span>
                <span id="statusText">Đang kiểm tra…</span>
              </span>

              <span class="chip">
                Updated (VN):
                <span class="mono" id="metaUpdatedVn">—</span>
              </span>

              <span class="chip">
                SHA:
                <span class="mono" id="metaSha">—</span>
              </span>

              <span class="chip">
                Run:
                <span class="mono" id="metaRun">—</span>
              </span>

              <!-- <a class="btn btn-chip" href="./data/xsmb.json" target="_blank" rel="noopener">xsmb.json</a>
              <a class="btn btn-chip" href="./data/last7.json" target="_blank" rel="noopener">last7.json</a>
              <a class="btn btn-chip" href="./data/site_meta.json" target="_blank" rel="noopener">meta</a> -->
            </div>
          </div>

          <div class="alert alert-danger mt-3 mb-0 d-none" id="topError">
            <div class="fw-bold">Lỗi tải dữ liệu</div>
            <div class="mono small" id="topErrorText">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- KẾT QUẢ MỚI NHẤT -->
    <div class="card-glass p-3 p-md-4 mb-3 mb-md-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div class="h5 mb-0 section-title">Kết quả mới nhất</div>
        <!-- <div class="chip">
          Nguồn:
          <span class="mono" id="metaSource">—</span>
        </div> -->
      </div>

      <div class="row g-3">
        <div class="col-12 col-md-4">
          <div class="card-glass p-3 h-100">
            <div class="text-secondary">Ngày</div>
            <div class="big-number" id="latestDate">—</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="card-glass p-3 h-100">
            <div class="text-secondary">Giải đặc biệt</div>
            <div class="big-number mono" id="latestSpecial">—</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="card-glass p-3 h-100">
            <div class="text-secondary">Đề (2 số cuối ĐB)</div>
            <div class="big-number mono" id="latestDe">—</div>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th style="width: 180px;">Giải</th>
                <th>Kết quả</th>
              </tr>
            </thead>
            <tbody id="latestTable">
              <tr><td colspan="2" class="text-secondary">Đang tải…</td></tr>
            </tbody>
          </table>
        </div>
        <div class="text-secondary small mt-2"></div>
      </div>
    </div>

    <!-- LỊCH 7 NGÀY -->
    <div class="card-glass p-3 p-md-4 mb-3 mb-md-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div class="h5 mb-0 section-title">Lịch gần nhất 7 ngày (đầy đủ)</div>
        <div class="text-secondary small">
          Quy tắc hiển thị số: <b>ĐB/G1/G2/G3 = 5 số</b> • <b>G4/G5 = 4 số</b> • <b>G6 = 3 số</b> • <b>G7 = 2 số</b>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th>Ngày</th>
              <th>ĐB</th>
              <th>Nhất</th>
              <th>Nhì</th>
              <th>Ba</th>
              <th>Tư</th>
              <th>Năm</th>
              <th>Sáu</th>
              <th>Bảy</th>
            </tr>
          </thead>
          <tbody id="last7Table">
            <tr><td colspan="9" class="text-secondary">Đang tải…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- TOP 10 (TEXT) -->
    <div class="row g-3 g-md-4 mb-3 mb-md-4">
      <div class="col-12 col-lg-6">
        <div class="card-glass p-3 p-md-4 h-100">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="h5 mb-0 section-title">Top 10 số lâu chưa về (text)</div>
            <span class="help-i" data-bs-toggle="popover" data-bs-placement="left"
              data-bs-title="Top 10 số lâu chưa về"
              data-bs-content="Danh sách 10 số có khoảng cách (delta) lớn nhất so với lần xuất hiện gần nhất, tính theo dữ liệu hiện có.">
              i
            </span>
          </div>
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead>
                <tr>
                  <th style="width: 56px;">#</th>
                  <th>Số</th>
                  <th>Delta (ngày)</th>
                </tr>
              </thead>
              <tbody id="top10DeltaTable">
                <tr><td colspan="3" class="text-secondary">Đang tải…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card-glass p-3 p-md-4 h-100">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="h5 mb-0 section-title">Top 10 (30 ngày) (text)</div>
            <span class="help-i" data-bs-toggle="popover" data-bs-placement="left"
              data-bs-title="Top 10 trong 30 ngày"
              data-bs-content="Tổng hợp tần suất xuất hiện của các số trong 30 ngày gần nhất (nếu file top10_30d.json có).">
              i
            </span>
          </div>
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead>
                <tr>
                  <th style="width: 56px;">#</th>
                  <th>Số</th>
                  <th>Số lần</th>
                </tr>
              </thead>
              <tbody id="top10_30dTable">
                <tr><td colspan="3" class="text-secondary">Đang tải…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- BIỂU ĐỒ (ẢNH) - tự ẩn nếu không có -->
    <div class="card-glass p-3 p-md-4 mb-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div class="h5 mb-0 section-title">Biểu đồ (tự ẩn nếu chưa có ảnh)</div>
        <div class="text-secondary small">Nếu file ảnh chưa tồn tại trong <span class="mono">/images</span> thì ô đó sẽ tự ẩn.</div>
      </div>

      <div class="row g-3" id="chartsGrid">
        <!-- Mỗi chart-card có data-src, JS sẽ kiểm tra tồn tại rồi mới hiện -->
        <div class="col-12 col-lg-6 chart-card" data-src="./images/top10_delta.png">
          <div class="card-glass p-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-bold">Top 10 lâu chưa về (chart)</div>
              <span class="help-i" data-bs-toggle="popover" data-bs-placement="left"
                data-bs-title="Biểu đồ Top 10 lâu chưa về"
                data-bs-content="Ảnh được tạo tự động từ pipeline. Nếu chưa có dữ liệu/ảnh, mục này sẽ tự ẩn.">
                i
              </span>
            </div>
            <img class="img-chart" alt="Top 10 lâu chưa về" />
          </div>
        </div>

        <div class="col-12 col-lg-6 chart-card" data-src="./images/top10_30d.png">
          <div class="card-glass p-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-bold">Top 10 (30 ngày) (chart)</div>
              <span class="help-i" data-bs-toggle="popover" data-bs-placement="left"
                data-bs-title="Biểu đồ Top 10 (30 ngày)"
                data-bs-content="Ảnh tần suất 30 ngày gần nhất. Tự ẩn nếu file chưa tồn tại.">
                i
              </span>
            </div>
            <img class="img-chart" alt="Top 10 30 ngày" />
          </div>
        </div>

        <div class="col-12 col-lg-6 chart-card" data-src="./images/line_30d_total.png">
          <div class="card-glass p-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-bold">Line 30D Total</div>
              <span class="help-i" data-bs-toggle="popover" data-bs-placement="left"
                data-bs-title="Line 30D Total"
                data-bs-content="Đường biểu diễn tổng số lần xuất hiện theo ngày trong 30 ngày. Tự ẩn nếu chưa có ảnh.">
                i
              </span>
            </div>
            <img class="img-chart" alt="30D total" />
          </div>
        </div>

        <div class="col-12 col-lg-6 chart-card" data-src="./images/line_30d_unique.png">
          <div class="card-glass p-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-bold">Line 30D Unique</div>
              <span class="help-i" data-bs-toggle="popover" data-bs-placement="left"
                data-bs-title="Line 30D Unique"
                data-bs-content="Đường biểu diễn số lượng số khác nhau xuất hiện theo ngày trong 30 ngày. Tự ẩn nếu chưa có ảnh.">
                i
              </span>
            </div>
            <img class="img-chart" alt="30D unique" />
          </div>
        </div>

        <div class="col-12 col-lg-6 chart-card" data-src="./images/heatmap_1y.png">
          <div class="card-glass p-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-bold">Heatmap (1 năm)</div>
              <span class="help-i" data-bs-toggle="popover" data-bs-placement="left"
                data-bs-title="Heatmap (1 năm)"
                data-bs-content="Bản đồ nhiệt theo ngày trong 1 năm. Tự ẩn nếu chưa có ảnh.">
                i
              </span>
            </div>
            <img class="img-chart" alt="heatmap" />
          </div>
        </div>

        <div class="col-12 col-lg-6 chart-card" data-src="./images/distribution_1y.png">
          <div class="card-glass p-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-bold">Distribution (1 năm)</div>
              <span class="help-i" data-bs-toggle="popover" data-bs-placement="left"
                data-bs-title="Distribution (1 năm)"
                data-bs-content="Phân phối tần suất theo 00–99 trong 1 năm. Tự ẩn nếu chưa có ảnh.">
                i
              </span>
            </div>
            <img class="img-chart" alt="dist" />
          </div>
        </div>
      </div>

      <div class="text-secondary small mt-3">
        Mẹo: Nếu bạn đặt tên ảnh khác, chỉ cần sửa <span class="mono">data-src</span> phía trên cho đúng.
      </div>
    </div>

    <div class="text-center text-secondary small pb-3">
    CHUN3NGAN © 2026
    </div>

  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ========= Helpers =========
    const $ = (sel) => document.querySelector(sel);

    async function fetchJson(url, {allow404=false} = {}) {
      const res = await fetch(url, {cache: "no-store"});
      if (!res.ok) {
        if (allow404 && res.status === 404) return null;
        throw new Error(`${url} HTTP ${res.status}`);
      }
      return res.json();
    }

    function padNum(value, width) {
      // value có thể là number hoặc string
      if (value === null || value === undefined) return "—";
      const s = String(value).trim();
      if (!s) return "—";
      // Nếu có dấu '-' hay không phải số thuần, vẫn pad theo chuỗi
      const digits = s.replace(/\D/g,'');
      // Nếu s là số (vd "2817"), pad. Nếu s có ký tự khác, trả nguyên.
      if (/^\d+$/.test(s)) return s.padStart(width, "0");
      if (digits.length && digits.length < width && digits === s) return s.padStart(width, "0");
      return s;
    }

    // Quy tắc:
    // ĐB: 5, G1: 5, G2/G3: 5, G4/G5: 4, G6: 3, G7: 2
    function fmtPrize(key, value) {
      const k = key.toLowerCase();
      if (k === "special") return padNum(value, 5);
      if (k === "prize1") return padNum(value, 5);

      if (k.startsWith("prize2_")) return padNum(value, 5);
      if (k.startsWith("prize3_")) return padNum(value, 5);

      if (k.startsWith("prize4_")) return padNum(value, 4);
      if (k.startsWith("prize5_")) return padNum(value, 4);

      if (k.startsWith("prize6_")) return padNum(value, 3);

      if (k.startsWith("prize7_")) return padNum(value, 2);

      return String(value ?? "—");
    }

    function toVnDisplayDate(isoLike) {
      // Hiển thị dạng dd/mm/yyyy (phù hợp VN) cho "Ngày" kết quả
      // isoLike ví dụ: "2026-01-14T00:00:00.000"
      if (!isoLike) return "—";
      const d = new Date(isoLike);
      if (isNaN(d.getTime())) return String(isoLike);
      const fmt = new Intl.DateTimeFormat("vi-VN", { timeZone: "Asia/Ho_Chi_Minh", day:"2-digit", month:"2-digit", year:"numeric" });
      return fmt.format(d);
    }

    function setStatus(kind, text) {
      const dot = $("#statusDot");
      const t = $("#statusText");
      dot.classList.remove("ok","warn","bad");
      dot.classList.add(kind);
      t.textContent = text;
    }

    function showTopError(errText) {
      $("#topError").classList.remove("d-none");
      $("#topErrorText").textContent = errText;
      setStatus("bad", "Lỗi tải dữ liệu");
    }

    // ========= Render latest =========
    function renderLatest(row) {
      // row: object của 1 ngày
      const dateStr = toVnDisplayDate(row?.date);
      $("#latestDate").textContent = dateStr;

      const special5 = fmtPrize("special", row?.special);
      $("#latestSpecial").textContent = special5;
      $("#latestDe").textContent = special5.slice(-2);

      const groups = [
        { label: "Giải ĐB", values: [fmtPrize("special", row?.special)] },
        { label: "Giải nhất", values: [fmtPrize("prize1", row?.prize1)] },
        { label: "Giải nhì", values: [fmtPrize("prize2_1", row?.prize2_1), fmtPrize("prize2_2", row?.prize2_2)] },
        { label: "Giải ba", values: [
          fmtPrize("prize3_1", row?.prize3_1), fmtPrize("prize3_2", row?.prize3_2), fmtPrize("prize3_3", row?.prize3_3),
          fmtPrize("prize3_4", row?.prize3_4), fmtPrize("prize3_5", row?.prize3_5), fmtPrize("prize3_6", row?.prize3_6),
        ] },
        { label: "Giải tư", values: [
          fmtPrize("prize4_1", row?.prize4_1), fmtPrize("prize4_2", row?.prize4_2),
          fmtPrize("prize4_3", row?.prize4_3), fmtPrize("prize4_4", row?.prize4_4),
        ] },
        { label: "Giải năm", values: [
          fmtPrize("prize5_1", row?.prize5_1), fmtPrize("prize5_2", row?.prize5_2), fmtPrize("prize5_3", row?.prize5_3),
          fmtPrize("prize5_4", row?.prize5_4), fmtPrize("prize5_5", row?.prize5_5), fmtPrize("prize5_6", row?.prize5_6),
        ] },
        { label: "Giải sáu", values: [
          fmtPrize("prize6_1", row?.prize6_1), fmtPrize("prize6_2", row?.prize6_2), fmtPrize("prize6_3", row?.prize6_3),
        ] },
        { label: "Giải bảy", values: [
          fmtPrize("prize7_1", row?.prize7_1), fmtPrize("prize7_2", row?.prize7_2),
          fmtPrize("prize7_3", row?.prize7_3), fmtPrize("prize7_4", row?.prize7_4),
        ] },
      ];

      const tbody = $("#latestTable");
      tbody.innerHTML = groups.map(g => {
        const v = g.values.filter(x => x && x !== "—").join(", ");
        return `<tr>
          <td class="text-secondary fw-semibold">${g.label}</td>
          <td class="mono">${v || "—"}</td>
        </tr>`;
      }).join("");
    }

    // ========= Render last 7 =========
    function renderLast7(list) {
      const tbody = $("#last7Table");
      if (!Array.isArray(list) || list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-secondary">Chưa có dữ liệu.</td></tr>`;
        return;
      }

      tbody.innerHTML = list.map(row => {
        const date = toVnDisplayDate(row?.date);
        const db = fmtPrize("special", row?.special);
        const nhat = fmtPrize("prize1", row?.prize1);
        const nhi = [fmtPrize("prize2_1", row?.prize2_1), fmtPrize("prize2_2", row?.prize2_2)].join(", ");
        const ba = [
          fmtPrize("prize3_1", row?.prize3_1), fmtPrize("prize3_2", row?.prize3_2), fmtPrize("prize3_3", row?.prize3_3),
          fmtPrize("prize3_4", row?.prize3_4), fmtPrize("prize3_5", row?.prize3_5), fmtPrize("prize3_6", row?.prize3_6),
        ].join(", ");
        const tu = [
          fmtPrize("prize4_1", row?.prize4_1), fmtPrize("prize4_2", row?.prize4_2),
          fmtPrize("prize4_3", row?.prize4_3), fmtPrize("prize4_4", row?.prize4_4),
        ].join(", ");
        const nam = [
          fmtPrize("prize5_1", row?.prize5_1), fmtPrize("prize5_2", row?.prize5_2), fmtPrize("prize5_3", row?.prize5_3),
          fmtPrize("prize5_4", row?.prize5_4), fmtPrize("prize5_5", row?.prize5_5), fmtPrize("prize5_6", row?.prize5_6),
        ].join(", ");
        const sau = [fmtPrize("prize6_1", row?.prize6_1), fmtPrize("prize6_2", row?.prize6_2), fmtPrize("prize6_3", row?.prize6_3)].join(", ");
        const bay = [fmtPrize("prize7_1", row?.prize7_1), fmtPrize("prize7_2", row?.prize7_2), fmtPrize("prize7_3", row?.prize7_3), fmtPrize("prize7_4", row?.prize7_4)].join(", ");

        return `<tr>
          <td class="fw-semibold">${date}</td>
          <td class="mono">${db}</td>
          <td class="mono">${nhat}</td>
          <td class="mono">${nhi}</td>
          <td class="mono">${ba}</td>
          <td class="mono">${tu}</td>
          <td class="mono">${nam}</td>
          <td class="mono">${sau}</td>
          <td class="mono">${bay}</td>
        </tr>`;
      }).join("");
    }

    // ========= Render top10 tables =========
    function renderTop10Delta(data) {
      const tbody = $("#top10DeltaTable");
      if (!data) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-secondary">Chưa có file top10_delta.json.</td></tr>`;
        return;
      }

      // Cho phép 2 format:
      // 1) [{ "so": "17", "delta": 123 }, ...]
      // 2) { "items": [...] }
      const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
      if (!items.length) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-secondary">Chưa có dữ liệu Top 10.</td></tr>`;
        return;
      }
      tbody.innerHTML = items.slice(0,10).map((it, idx) => {
        const so = padNum(it.so ?? it.num ?? it.number ?? it.value, 2);
        const delta = it.delta ?? it.days ?? it.d ?? "—";
        return `<tr>
          <td class="text-secondary fw-semibold">${idx+1}</td>
          <td class="mono fw-bold">${so}</td>
          <td class="mono">${delta}</td>
        </tr>`;
      }).join("");
    }

    function renderTop10_30d(data) {
      const tbody = $("#top10_30dTable");
      if (!data) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-secondary">Chưa có file top10_30d.json.</td></tr>`;
        return;
      }
      const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
      if (!items.length) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-secondary">Chưa có dữ liệu Top 10 (30 ngày).</td></tr>`;
        return;
      }
      tbody.innerHTML = items.slice(0,10).map((it, idx) => {
        const so = padNum(it.so ?? it.num ?? it.number ?? it.value, 2);
        const count = it.count ?? it.times ?? it.freq ?? "—";
        return `<tr>
          <td class="text-secondary fw-semibold">${idx+1}</td>
          <td class="mono fw-bold">${so}</td>
          <td class="mono">${count}</td>
        </tr>`;
      }).join("");
    }

    // ========= Charts: auto hide if image not exist =========
    async function checkImageExists(url) {
      // Same-origin: HEAD thường OK. Nếu HEAD fail, thử GET.
      try {
        const res = await fetch(url, { method: "HEAD", cache: "no-store" });
        if (res.ok) return true;
        if (res.status === 404) return false;
      } catch (e) {}
      try {
        const res2 = await fetch(url, { method: "GET", cache: "no-store" });
        return res2.ok;
      } catch (e) {
        return false;
      }
    }

    async function initCharts() {
      const cards = Array.from(document.querySelectorAll(".chart-card"));
      let anyShown = false;

      await Promise.all(cards.map(async (card) => {
        const src = card.getAttribute("data-src");
        const ok = await checkImageExists(src);
        if (!ok) {
          card.classList.add("d-none");
          return;
        }
        const img = card.querySelector("img");
        img.src = src + "?v=" + Date.now(); // bust cache
        anyShown = true;
      }));

      if (!anyShown) {
        // Nếu tất cả đều ẩn, show 1 dòng gợi ý
        const grid = $("#chartsGrid");
        const hint = document.createElement("div");
        hint.className = "col-12";
        hint.innerHTML = `<div class="alert alert-warning mb-0">
          Hiện chưa có ảnh biểu đồ trong thư mục <span class="mono">/images</span>. Khi workflow tạo ảnh, các ô sẽ tự hiện.
        </div>`;
        grid.appendChild(hint);
      }
    }

    // ========= Popovers (icon i) =========
    function initPopovers() {
      const els = document.querySelectorAll('[data-bs-toggle="popover"]');
      els.forEach(el => {
        new bootstrap.Popover(el, {
          trigger: "hover focus", // di chuột hoặc bấm
          container: "body"
        });
      });
    }

    // ========= Main =========
    async function main() {
      initPopovers();

      // 1) Load meta trước để hiển thị Updated(VN) đúng dạng ISO +07:00 nếu có
      let meta = null;
      try {
        meta = await fetchJson("./data/site_meta.json", {allow404:true});
      } catch (e) {
        // không chặn trang nếu meta lỗi
      }

      if (meta) {
        $("#metaUpdatedVn").textContent = meta.updated_at_vn || meta.updated_vn || "—";
        $("#metaSha").textContent = meta.sha || "—";
        $("#metaRun").textContent = meta.run_id || meta.run || "—";
        $("#metaSource").textContent = meta.source || "—";

        // Status theo note
        const note = (meta.note || "").toLowerCase();
        if (note.includes("chưa") || note.includes("chua") || note.includes("no data")) {
          setStatus("warn", "Online • Chưa có dữ liệu");
        } else {
          setStatus("ok", "Online • Đã tải dữ liệu");
        }
      } else {
        $("#metaUpdatedVn").textContent = "—";
        $("#metaSha").textContent = "—";
        $("#metaRun").textContent = "—";
        $("#metaSource").textContent = "—";
        setStatus("warn", "Online • Chưa có meta");
      }

      // 2) Load dữ liệu chính
      try {
        const xsmb = await fetchJson("./data/xsmb.json");
        // xsmb.json của bạn là mảng: [ {date, special, ...} ]
        const latest = Array.isArray(xsmb) && xsmb.length ? xsmb[0] : null;

        if (!latest) {
          $("#latestTable").innerHTML = `<tr><td colspan="2" class="text-secondary">Chưa có dữ liệu hôm nay.</td></tr>`;
          $("#latestDate").textContent = "—";
          $("#latestSpecial").textContent = "—";
          $("#latestDe").textContent = "—";
        } else {
          // Format "special" thành 5 số khi hiển thị (vd 2817 -> 02817)
          renderLatest(latest);
        }

        // last7
        const last7 = await fetchJson("./data/last7.json", {allow404:true});
        if (last7) renderLast7(last7);
        else $("#last7Table").innerHTML = `<tr><td colspan="9" class="text-secondary">Chưa có file last7.json.</td></tr>`;

        // top10 json (text)
        const top10Delta = await fetchJson("./data/top10_delta.json", {allow404:true});
        renderTop10Delta(top10Delta);

        const top10_30d = await fetchJson("./data/top10_30d.json", {allow404:true});
        renderTop10_30d(top10_30d);

        // Nếu load xsmb ok -> status ok (trừ khi meta note báo chưa có)
        if (!meta || !(String(meta.note||"").toLowerCase().includes("chưa") || String(meta.note||"").toLowerCase().includes("chua"))) {
          setStatus("ok", "Online • Đã tải dữ liệu");
        }

      } catch (e) {
        showTopError(String(e.message || e));
      }

      // 3) Charts
      await initCharts();
    }

    main();
  </script>
</body>
</html>
