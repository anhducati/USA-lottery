name: Daily Update XSMB Data

on:
  schedule:
    # 18:33 (VN, UTC+7) = 11:33 UTC
    - cron: "33 11 * * *"
  workflow_dispatch:
    inputs:
      date:
        description: "NgÃ y cáº§n láº¥y (YYYY-MM-DD). Bá» trá»‘ng = hÃ´m nay theo giá» VN."
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: daily-xsmb
  cancel-in-progress: true

jobs:
  update-data:
    runs-on: ubuntu-24.04
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -V
          pip install -r requirements.txt

      - name: Retry láº¥y káº¿t quáº£ (má»—i 30s) tá»« 18:33 Ä‘áº¿n khi cÃ³
        env:
          TZ: Asia/Ho_Chi_Minh
          INPUT_DATE: ${{ github.event.inputs.date }}
        run: |
          set -euo pipefail

          echo "============================================================"
          echo "ğŸ•’ Báº®T Äáº¦U (VN): $(date '+%Y-%m-%d %H:%M:%S %z')"
          echo "ğŸ“Œ Workflow: $GITHUB_WORKFLOW | Run: $GITHUB_RUN_ID"
          echo "ğŸ” Retry interval: 30s"
          echo "============================================================"

          # NgÃ y má»¥c tiÃªu: Æ°u tiÃªn input, náº¿u rá»—ng -> hÃ´m nay theo giá» VN
          if [ -n "${INPUT_DATE}" ]; then
            TARGET_DATE="${INPUT_DATE}"
          else
            TARGET_DATE="$(date '+%Y-%m-%d')"
          fi
          echo "ğŸ¯ NgÃ y cáº§n láº¥y: ${TARGET_DATE}"

          INTERVAL=30
          # 45 phÃºt timeout job => Ä‘á»ƒ dÆ°, láº¥y 80 láº§n ~ 40 phÃºt
          MAX_ATTEMPTS=80

          # Check "Ä‘Ã£ xá»•" dá»±a trÃªn data/xsmb.json
          is_ready() {
            TARGET_DATE="${TARGET_DATE}" python - <<'PY'
          import json, os, sys

          target = os.environ["TARGET_DATE"]
          path = "data/xsmb.json"

          try:
              with open(path, "r", encoding="utf-8") as f:
                  data = json.load(f)
          except Exception:
              # ChÆ°a cÃ³ file/Ä‘á»c lá»—i => coi nhÆ° chÆ°a cÃ³ káº¿t quáº£
              sys.exit(2)

          ok = False
          if isinstance(data, list):
              for row in data:
                  d = str(row.get("date", ""))
                  if d.startswith(target):
                      ok = row.get("special") is not None
                      break

          sys.exit(0 if ok else 2)
          PY
          }

          for i in $(seq 1 ${MAX_ATTEMPTS}); do
            echo "------------------------------------------------------------"
            echo "[$i/${MAX_ATTEMPTS}] â³ KIá»‚M TRA: ${TARGET_DATE} | VN: $(date '+%H:%M:%S')"

            # Cháº¡y tool update cá»§a báº¡n (khÃ´ng fail náº¿u scraper táº¡m thá»i lá»—i)
            python src/main.py || true

            if is_ready; then
              echo "âœ… ÄÃƒ Xá»”: ÄÃ£ cÃ³ káº¿t quáº£ cho ${TARGET_DATE} | VN: $(date '+%Y-%m-%d %H:%M:%S %z'))"
              break
            else
              if [ "$i" -lt "${MAX_ATTEMPTS}" ]; then
                echo "ğŸŸ¡ CHÆ¯A Xá»”: ChÆ°a cÃ³ káº¿t quáº£ cho ${TARGET_DATE}"
                echo "ğŸ” RETRY sau ${INTERVAL}s..."
                sleep ${INTERVAL}
              else
                echo "ğŸ”´ Háº¾T LÆ¯á»¢T RETRY: Váº«n CHÆ¯A CÃ“ Káº¾T QUáº¢ cho ${TARGET_DATE}"
                exit 1
              fi
            fi
          done

      - name: Commit & push náº¿u cÃ³ thay Ä‘á»•i
        env:
          TZ: Asia/Ho_Chi_Minh
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data images index.html .nojekyll 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "â„¹ï¸ KhÃ´ng cÃ³ thay Ä‘á»•i Ä‘á»ƒ commit | VN: $(date '+%Y-%m-%d %H:%M:%S %z')"
            exit 0
          fi

          git commit -m "chore: update XSMB data (VN $(date '+%Y-%m-%d %H:%M'))"
          git push
          echo "âœ… ÄÃ£ push dá»¯ liá»‡u má»›i | VN: $(date '+%Y-%m-%d %H:%M:%S %z')"
