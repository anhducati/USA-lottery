name: Daily Update Data

on:
  schedule:
    # 18:33 (VN, UTC+7) = 11:33 UTC
    - cron: "33 11 * * *"
  workflow_dispatch:
    inputs:
      date:
        description: "Ng√†y c·∫ßn l·∫•y (YYYY-MM-DD). B·ªè tr·ªëng = h√¥m nay theo gi·ªù VN."
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: daily-xsmb
  cancel-in-progress: true

jobs:
  update-data:
    runs-on: ubuntu-24.04
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -V
          pip install -r requirements.txt

      - name: Retry l·∫•y k·∫øt qu·∫£ (m·ªói 30s) t·ª´ 18:33 t·ªõi khi c√≥
        env:
          TZ: Asia/Ho_Chi_Minh
          INPUT_DATE: ${{ github.event.inputs.date }}
        run: |
          set -euo pipefail

          echo "üïí B·∫Øt ƒë·∫ßu (VN): $(date '+%Y-%m-%d %H:%M:%S %z')"
          echo "üîÅ Retry interval: 30s"

          # Ng√†y m·ª•c ti√™u: ∆∞u ti√™n input, n·∫øu r·ªóng -> h√¥m nay theo gi·ªù VN
          if [ -n "${INPUT_DATE:-}" ]; then
            TARGET_DATE="${INPUT_DATE}"
          else
            TARGET_DATE="$(date '+%Y-%m-%d')"
          fi

          export TARGET_DATE
          echo "üéØ Ng√†y c·∫ßn l·∫•y: ${TARGET_DATE}"

          INTERVAL=30
          MAX_ATTEMPTS=120   # 120 * 30s = 60 ph√∫t

          # Ki·ªÉm tra "ƒë√£ x·ªï" d·ª±a tr√™n data/xsmb.json
          is_ready() {
            python - <<'PY'
import json, sys, os
target = os.environ.get("TARGET_DATE", "")
path = "data/xsmb.json"
try:
    with open(path, "r", encoding="utf-8") as f:
        data = json.load(f)
except Exception:
    # file ch∆∞a c√≥ / l·ªói ƒë·ªçc => coi nh∆∞ ch∆∞a s·∫µn s√†ng
    sys.exit(2)

ok = False
if isinstance(data, list):
    for row in data:
        d = str(row.get("date", ""))
        if d.startswith(target):
            # c√≥ special (kh√¥ng None) coi nh∆∞ ƒë√£ c√≥ k·∫øt qu·∫£
            ok = (row.get("special") is not None)
            break

sys.exit(0 if ok else 2)
PY
          }

          for i in $(seq 1 ${MAX_ATTEMPTS}); do
            echo "------------------------------------------------------------"
            echo "[$i/${MAX_ATTEMPTS}] ‚è≥ KI·ªÇM TRA XSMB ${TARGET_DATE} (VN: $(date '+%H:%M:%S'))"

            # Ch·∫°y tool fetch/generate c·ªßa b·∫°n
            # N·∫øu ch∆∞a x·ªï, script c√≥ th·ªÉ kh√¥ng c·∫≠p nh·∫≠t file => is_ready v·∫´n fail (ƒë√∫ng)
            python src/main.py || true

            if is_ready; then
              echo "‚úÖ ƒê√É X·ªî! ƒê√£ c√≥ k·∫øt qu·∫£ cho ${TARGET_DATE} (VN: $(date '+%Y-%m-%d %H:%M:%S %z'))"
              break
            fi

            if [ "$i" -lt "${MAX_ATTEMPTS}" ]; then
              echo "üü° CH∆ØA X·ªî / CH∆ØA C√ì K·∫æT QU·∫¢ -> RETRY sau ${INTERVAL}s..."
              sleep ${INTERVAL}
            else
              echo "üî¥ H·∫æT RETRY (${MAX_ATTEMPTS} l·∫ßn). V·∫´n CH∆ØA C√ì K·∫æT QU·∫¢ cho ${TARGET_DATE}."
              exit 1
            fi
          done

      - name: Commit & push n·∫øu c√≥ thay ƒë·ªïi
        env:
          TZ: Asia/Ho_Chi_Minh
        run: |
          set -euo pipefail

          # ƒë·∫£m b·∫£o Pages kh√¥ng b·ªã Jekyll can thi·ªáp
          touch .nojekyll

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data images index.html .nojekyll 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è Kh√¥ng c√≥ thay ƒë·ªïi ƒë·ªÉ commit (VN: $(date '+%Y-%m-%d %H:%M:%S %z'))"
            exit 0
          fi

          git commit -m "chore: update XSMB data (VN $(date '+%Y-%m-%d %H:%M'))"
          git push
          echo "‚úÖ ƒê√£ push d·ªØ li·ªáu m·ªõi (VN: $(date '+%Y-%m-%d %H:%M:%S %z'))"
