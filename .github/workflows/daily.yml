name: Daily Update  Data 

on:
  schedule:
    # 18:33 (VN, UTC+7) = 11:33 UTC
    - cron: "33 11 * * *"
  workflow_dispatch:
    inputs:
      date:
        description: "Ng√†y c·∫ßn l·∫•y (YYYY-MM-DD). B·ªè tr·ªëng = h√¥m nay theo gi·ªù VN."
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: daily-xsmb
  cancel-in-progress: true

jobs:
  update-data:
    runs-on: ubuntu-24.04
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -V
          pip install -r requirements.txt

      - name: Retry l·∫•y k·∫øt qu·∫£ (m·ªói 30s) cho t·ªõi khi c√≥
        env:
          TZ: Asia/Ho_Chi_Minh
          INPUT_DATE: ${{ github.event.inputs.date }}
        run: |
          set -euo pipefail

          echo "üïí Th·ªùi gian b·∫Øt ƒë·∫ßu (VN): $(date '+%Y-%m-%d %H:%M:%S %z')"
          echo "üîÅ Retry interval: 30s"

          # Ng√†y m·ª•c ti√™u: ∆∞u ti√™n input, n·∫øu r·ªóng -> h√¥m nay theo gi·ªù VN
          if [ -n "${INPUT_DATE}" ]; then
            TARGET_DATE="${INPUT_DATE}"
          else
            TARGET_DATE="$(date '+%Y-%m-%d')"
          fi
          echo "üéØ Ng√†y c·∫ßn l·∫•y: ${TARGET_DATE}"

          # C·∫•u h√¨nh retry
          INTERVAL=30
          # 60 ph√∫t = 120 l·∫ßn (m·ªói 30s). B·∫°n c√≥ th·ªÉ tƒÉng n·∫øu mu·ªën.
          MAX_ATTEMPTS=120

          # H√†m ki·ªÉm tra "ƒë√£ x·ªï" hay ch∆∞a d·ª±a tr√™n data/xsmb.json
          # ƒêi·ªÅu ki·ªán: trong xsmb.json c√≥ record date b·∫Øt ƒë·∫ßu b·∫±ng TARGET_DATE
          # v√† c√≥ field "special" (ƒë·ªÉ tr√°nh tr∆∞·ªùng h·ª£p r·ªóng)
          is_ready() {
            python - <<'PY'
import json, sys, os
target = os.environ["TARGET_DATE"]
path = "data/xsmb.json"
try:
    with open(path, "r", encoding="utf-8") as f:
        data = json.load(f)
except Exception:
    sys.exit(1)

ok = False
for row in data if isinstance(data, list) else []:
    d = str(row.get("date",""))
    if d.startswith(target):
        # c√≥ special l√† coi nh∆∞ ƒë√£ c√≥ k·∫øt qu·∫£
        if row.get("special") is not None:
            ok = True
        break

sys.exit(0 if ok else 2)
PY
          }

          # V√≤ng l·∫∑p retry
          for i in $(seq 1 ${MAX_ATTEMPTS}); do
            echo "------------------------------------------------------------"
            echo "[$i/${MAX_ATTEMPTS}] ‚è≥ Ki·ªÉm tra k·∫øt qu·∫£ XSMB ng√†y ${TARGET_DATE} (VN: $(date '+%H:%M:%S'))"

            # Ch·∫°y scraper/generator c·ªßa b·∫°n
            # N·∫øu script c·ªßa b·∫°n t·ª± bi·∫øt h√¥m nay th√¨ kh√¥ng c·∫ßn truy·ªÅn date.
            # N·∫øu b·∫°n c√≥ h·ªó tr·ª£ tham s·ªë date th√¨ t·ª± th√™m v√†o ·ªü ƒë√¢y.
            python src/main.py || true

            if is_ready; then
              echo "‚úÖ ƒê√É X·ªî! ƒê√£ c√≥ k·∫øt qu·∫£ cho ${TARGET_DATE} (VN: $(date '+%Y-%m-%d %H:%M:%S %z'))"
              break
            else
              if [ "$i" -lt "${MAX_ATTEMPTS}" ]; then
                echo "üü° CH∆ØA X·ªî / CH∆ØA C√ì K·∫æT QU·∫¢ -> retry sau ${INTERVAL}s..."
                sleep ${INTERVAL}
              else
                echo "üî¥ H·∫æT TH·ªúI GIAN RETRY (${MAX_ATTEMPTS} l·∫ßn). V·∫´n CH∆ØA C√ì K·∫æT QU·∫¢ cho ${TARGET_DATE}."
                echo "‚û°Ô∏è B·∫°n c√≥ th·ªÉ tƒÉng MAX_ATTEMPTS n·∫øu mu·ªën ch·ªù l√¢u h∆°n."
                exit 1
              fi
            fi
          done

      - name: Commit & push n·∫øu c√≥ thay ƒë·ªïi
        env:
          TZ: Asia/Ho_Chi_Minh
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add ƒë√∫ng path (kh√¥ng c√≤n l·ªói site_meta.json)
          git add data images index.html .nojekyll 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è Kh√¥ng c√≥ thay ƒë·ªïi ƒë·ªÉ commit (VN: $(date '+%Y-%m-%d %H:%M:%S %z'))"
            exit 0
          fi

          git commit -m "chore: update XSMB data (VN $(date '+%Y-%m-%d %H:%M'))"
          git push
          echo "‚úÖ ƒê√£ push d·ªØ li·ªáu m·ªõi l√™n repo (VN: $(date '+%Y-%m-%d %H:%M:%S %z'))"
